<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-9BVF6sfbA1IcmawTtxFiwHOyHv0Qa3g",
    authDomain: "rifas-con-causa.firebaseapp.com",
    projectId: "rifas-con-causa",
    storageBucket: "rifas-con-causa.appspot.com",
    messagingSenderId: "347417635634",
    appId: "1:347417635634:web:3ddab8921d26707910452b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const params = new URLSearchParams(window.location.search);
  const numBoleto = params.get("boleto") || "???";
  document.getElementById("boletoTitulo").innerText = `Boleto #${numBoleto}`;

  document.getElementById("formRegistro").addEventListener("submit", async function(e){
    e.preventDefault();

    const nombre = document.getElementById("nombre").value.trim();
    const telefono = document.getElementById("telefono").value.trim();
    const poblacion = document.getElementById("poblacion").value.trim();

    try {
      await setDoc(doc(db, "BoletosRifa", numBoleto), {
        nombre: nombre,
        telefono: telefono,
        poblacion: poblacion,
        estado: "apartado",
        formaPago: "pendiente",
        fecha: serverTimestamp()
      }, { merge: true });

      Swal.fire({
        title: `‚úÖ ¬°Boleto #${numBoleto} registrado correctamente!`,
        html: `
<div id="swalContent" style="max-width:100%; font-size:1em;">
  <p>GRACIAS... El sistema te da 4 horas para pagar, y lo pone disponible otra vez, si no se paga.</p>
  <p>Env√≠a comprobante de pago al WhatsApp <strong>3311571619</strong>.</p>
  <p><strong>Cuenta Spin OXXO:</strong> 4217 4701 5601 6160<br>
     <strong>CLABE:</strong> 7289 6900 0143 3179 21</p>
  <p><em>T√≥male captura de pantalla si es necesario.</em></p>
  <p>Este dato tambi√©n lo encuentras en la p√°gina principal en el bot√≥n "Bases del sorteo".</p>
  <hr>
  <p>üìå Si pagaste por OXXO, favor de anotar tu nombre con lapicera en el ticket antes de tomarle foto. <br>
  <b>Si pagaste por transferencia, en concepto solo pon tu nombre</b> o contacta a tu promotor y acuerda si le pagas en efectivo.</p>
  <p>GRACIAS... Estamos al pendiente de tu respuesta. Acciones nobles como la tuya merecen una recompensa... SUERTE.</p>
  <div style="text-align:center; margin-top:20px;">
    <p style="margin-bottom:8px; font-size:1em; color:#28a745; font-weight:bold;">
      ‚úÖ Avisar que ya apart√© mi boleto
    </p>
    <a href="https://wa.me/523311571619?text=Hola,%20me%20comunico%20desde%20la%20rifa.%20En%20cuanto%20pueda%20te%20env%C3%ADo%20el%20comprobante%20de%20pago%20de%20mi%20boleto%20n%C3%BAmero%20${numBoleto}.%20%C2%A1Gracias!"
       target="_blank"
       style="display:inline-block; background:#25D366; color:white; padding:12px 24px; border-radius:8px; text-decoration:none; font-size:1.1em; font-weight:bold;">
      üì© GRACIAS
    </a>
  </div>`
      }).then(() => {
        window.location.href = 'panel-boletos-rifa.html';
      });

    } catch (error) {
      console.error("‚ùå Error al registrar el boleto:", error);
      alert("Ocurri√≥ un error al registrar el boleto. Intenta nuevamente.");
    }
  });
</script>
