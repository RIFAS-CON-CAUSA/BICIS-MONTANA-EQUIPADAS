<!-- Proyecto Rifa Bicis Montaña - Estructura base para continuar trabajo -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rifa Bicis Montaña</title>
  <link rel="stylesheet" href="estilos.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      // Tu configuración aquí
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function actualizarEstado(id, forma, estado, rolActivo, datosBoletos) {
      try {
        await updateDoc(doc(db, "BoletosRifa", id), {
          formaPago: forma,
          estado: estado,
          modificadoPor: rolActivo,
          fecha: serverTimestamp()
        });

        const b = datosBoletos.find(b => b.id === id);
        if (estado === "pagado" && b) {
          const oportunidades = Array.isArray(b.series) ? b.series.slice(0, 10) : [];
          generarBoleto(
            b.nombre || "Participante",
            b.poblacion || "",
            b.boleto || "000",
            oportunidades,
            b.telefono || ""
          );

          const mensaje = "📩 ¡Gracias por apoyar la causa! Aquí tienes tu boleto #" + b.boleto +
            " de la rifa de bicicletas.\n\n✅ Participas con 10 oportunidades.\n\nMás información en: https://rifas-con-causa.github.io/BICIS-MONTANA-EQUIPADAS/index.html";

          const numeroLimpio = (b.telefono || "").replace(/\D/g, "");
          if (numeroLimpio.length >= 10) {
            const waURL = `https://wa.me/52${numeroLimpio}?text=${encodeURIComponent(mensaje)}`;
            window.open(waURL, "_blank");
          } else {
            console.warn("📵 Teléfono no válido para WhatsApp:", b.telefono);
          }
        }

        alert("✅ Guardado correctamente.");
        cargarBoletos();
      } catch (error) {
        console.error("❌ Error al guardar:", error);
        alert("❌ Ocurrió un error al guardar.");
      }
    }

    function generarBoleto(nombre, poblacion, folio, oportunidades, telefono) {
      const div = document.createElement("div");
      div.id = "boletoRecibo";
      div.style = `
        width: 300px;
        padding: 20px;
        border: 2px solid #000;
        border-radius: 10px;
        background: #f8f9fa;
        font-family: Arial;
        color: #333;
        text-align: center;
      `;

      div.innerHTML = `
        <h2 style="margin-bottom: 10px;">🎟️ Boleto de Rifa</h2>
        <p><strong>Nombre:</strong> ${nombre}</p>
        <p><strong>Población:</strong> ${poblacion}</p>
        <p><strong>Folio:</strong> ${folio}</p>
        <p><strong>Oportunidades:</strong><br>${oportunidades.join(", ")}</p>
        <p style="margin-top:15px; font-weight: bold;">¡Gracias por apoyar la causa!</p>
      `;

      document.body.appendChild(div);

      html2canvas(div).then(canvas => {
        const link = document.createElement("a");
        link.download = `BOLETO-${folio}.png`;
        link.href = canvas.toDataURL();
        link.click();
        document.body.removeChild(div);
      });
    }
  </script>
</head>
<body>
  <header>
    <h1>🎉 Gran Rifa de Bicicletas de Montaña 🎉</h1>
    <p>Participa con solo $160 pesos y obtén 10 oportunidades para ganar.</p>
    <p>Basado en la Lotería Nacional - Sorteo 30 de mayo</p>
  </header>

  <section id="registro">
    <h2>Reserva tu boleto</h2>
    <!-- Aquí se insertará el formulario o panel de reserva -->
  </section>

  <section id="boletos">
    <h2>Boletos disponibles</h2>
    <!-- Aquí se mostrará la lista dinámica de boletos -->
  </section>

  <footer>
    <p>📞 Informes al WhatsApp: <a href="https://wa.me/527327777777" target="_blank">327 777 7777</a></p>
    <p>Sistema desarrollado por Rifas con Causa</p>
  </footer>
</body>
</html>
