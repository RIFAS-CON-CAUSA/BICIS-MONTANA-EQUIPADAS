<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Admin - Rifas con Causa</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    .archivo-seleccionado {
      background-color: #e0f7fa !important;
      border: 2px dashed #00796b;
    }
  </style>
</head>
<body>
  <h1 id="tituloPanel">Panel de Control</h1>
  <p style="font-size: 0.95em; margin-top: -10px; margin-bottom: 20px; line-height: 1.4; color: #333;">
    ‚ö†Ô∏è <strong>INSTRUCCIONES IMPORTANTES PARA LOS ROLES:</strong><br>
    ‚Ä¢ Toma en cuenta que al cambiar un estado a <strong>"PAGADO"</strong>, <u>ya no podr√°s devolverlo a otro estado</u>.<br>
    ‚Ä¢ Deber√°s comunicarte con el <strong>ADMIN</strong> para que realice la correcci√≥n si fue un error.<br>
    ‚Ä¢ Y recuerda que si el cliente paga por <strong>TRANSFERENCIA a la cuenta del ADMIN</strong>,<br>
    &nbsp;&nbsp;&nbsp;&nbsp;el cambio de estado <u>debe hacerlo exclusivamente el ADMIN</u>,<br>
    &nbsp;&nbsp;&nbsp;&nbsp;ya que ese monto no entrar√° a tu cuenta de ingresos.
  </p>

  <table border="1" id="tablaBoletos">
    <thead>
      <tr>
        <th>Boleto</th>
        <th>Nombre</th>
        <th>Tel√©fono</th>
        <th>Poblaci√≥n</th>
        <th>Estado</th>
        <th>Fecha</th>
        <th>Modificado por</th>
        <th>Forma Pago</th>
        <th>Acci√≥n</th>
        <th>Comprobante</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC-9BVF6sfbA1IcmawTtxFiwHOyHv0Qa3g",
      authDomain: "rifas-con-causa.firebaseapp.com",
      projectId: "rifas-con-causa",
      storageBucket: "rifas-con-causa.firebasestorage.app",
      messagingSenderId: "347417635634",
      appId: "1:347417635634:web:3ddab8921d26707910452b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let datosBoletos = [];
    window.archivoSeleccionadoData = {};

    window.archivoSeleccionado = function(id, archivo) {
      if (archivo) {
        archivoSeleccionadoData[id] = archivo;
        document.getElementById("celda-" + id).classList.add("archivo-seleccionado");
      }
    };

    window.subirComprobante = async function(id) {
      const archivo = archivoSeleccionadoData[id];
      if (!archivo) return alert("Primero selecciona un archivo.");

      const extension = archivo.name.split('.').pop();
      const storageRef = ref(storage, `comprobantes/boletos/${id}.${extension}`);

      try {
        await uploadBytes(storageRef, archivo);
        const url = await getDownloadURL(storageRef);

        await updateDoc(doc(db, "BoletosRifa", id), {
          comprobanteUrl: url
        });

        alert("‚úÖ Comprobante subido correctamente.");
        await cargarBoletos();

        document.getElementById("celda-" + id).classList.remove("archivo-seleccionado");
        delete archivoSeleccionadoData[id];
      } catch (error) {
        console.error("‚ùå Error al subir comprobante:", error);
        alert("Error al subir comprobante.");
      }
    };

    async function cargarBoletos() {
      const querySnapshot = await getDocs(collection(db, "BoletosRifa"));
      datosBoletos = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      const tbody = document.querySelector("#tablaBoletos tbody");
      tbody.innerHTML = "";

      datosBoletos.forEach(b => {
        const fechaFormateada = b.fecha
          ? (b.fecha.toDate ? b.fecha.toDate().toLocaleString() : new Date(b.fecha).toLocaleString())
          : "";

        const rowColor = b.estado === "pagado"
          ? "style='background:#e74c3c; color:white'"
          : (b.estado === "apartado"
            ? "style='background:#f1c40f;'"
            : "style='background:#2ecc71; color:white'");

        tbody.innerHTML += `<tr ${rowColor}>
          <td>${b.boleto}</td>
          <td>${b.nombre || ""}</td>
          <td>${b.telefono || ""}</td>
          <td>${b.poblacion || ""}</td>
          <td>${b.estado}</td>
          <td>${fechaFormateada}</td>
          <td>${b.modificadoPor || ""}</td>
          <td>${b.formaPago || ""}</td>
          <td>
            <select onchange="cambiarEstado('${b.id}', this.value)">
              <option disabled selected>Cambiar</option>
              <option value="libre">Libre</option>
              <option value="apartado">Apartado</option>
              <option value="pagado">Pagado</option>
            </select>
          </td>
          <td id="celda-${b.id}">
            <input type="file" accept="image/*" style="display:none;" id="file-${b.id}" onchange="archivoSeleccionado('${b.id}', this.files[0])">
            <button onclick="document.getElementById('file-${b.id}').click()" style="font-size: 0.9em;">üìÅ Seleccionar</button>
            <button onclick="subirComprobante('${b.id}')" style="font-size: 0.9em;">‚¨ÜÔ∏è Subir</button>
            <br>
            ${b.comprobanteUrl ? '‚úÖ ' : ''}
            <a href="${b.comprobanteUrl || '#'}" target="_blank" style="font-size: 0.9em;">üìé Ver comprobante</a>
          </td>
        </tr>`;
      });
    }

    window.cambiarEstado = async function(id, nuevoEstado) {
      const boletoOriginal = datosBoletos.find(b => b.id === id);
      if (!boletoOriginal) return alert("‚ö†Ô∏è No se encontr√≥ el boleto.");

      if (boletoOriginal.estado === "pagado" && rolActivo !== "admin") {
        return alert("‚ùå Solo el ADMIN puede cambiar un boleto pagado a otro estado. si cometiste error comunicate con el admnistrador de la rifa ");
      }

      let formaPago = "";
      if (nuevoEstado === "pagado") {
        formaPago = prompt("Forma de pago (Efectivo, OXXO, etc):");
        if (!formaPago) formaPago = "No especificado";
      }

      try {
        const ref = doc(db, "BoletosRifa", id);
        await updateDoc(ref, {
          estado: nuevoEstado,
          modificadoPor: rolActivo,
          formaPago: formaPago,
          fecha: serverTimestamp()
        });

        alert("‚úÖ Estado actualizado correctamente por: " + rolActivo);
        await cargarBoletos();
      } catch (error) {
        console.error("‚ùå Error al actualizar el boleto:", error);
        alert("Error al actualizar el boleto.");
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      const accesos = {
        "admin": "admin2024",
        "miriam": "mc24",
        "patty": "pt25",
        "diane": "dn26",
        "steven": "sv27",
        "manuel": "admin2024"
      };

      setTimeout(() => {
        const clave = prompt("üîí Ingresa tu clave de acceso:");
        const usuario = Object.keys(accesos).find(k => accesos[k] === clave);

        if (usuario) {
          rolActivo = usuario;
          document.title = "Panel - Bienvenido " + usuario.charAt(0).toUpperCase() + usuario.slice(1);
          const encabezado = document.getElementById("tituloPanel");
          if (encabezado) encabezado.innerText = "Bienvenido " + usuario.charAt(0).toUpperCase() + usuario.slice(1);
          cargarBoletos();
        } else {
          alert("üö´ Clave incorrecta. No tienes acceso.");
          document.body.innerHTML = "<h2 style='color:red;text-align:center;'>ACCESO DENEGADO</h2>";
        }
      }, 100);
    });
  </script>
</body>
</html>
