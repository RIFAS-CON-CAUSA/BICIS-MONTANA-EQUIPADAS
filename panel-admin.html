<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <meta charset="UTF-8">
  <title>Panel Admin - Rifas con Causa</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #f4f4f4;
    }
  </style>
</head>
<body>
  <h1>Panel de Control de Boletos</h1>

  <table id="tablaBoletos">
    <thead>
      <tr>
        <th>Boleto</th>
        <th>Nombre</th>
        <th>Tel√©fono</th>
        <th>Estado</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-9BVF6sfbA1IcmawTtxFiwHOyHv0Qa3g",
    authDomain: "rifas-con-causa.firebaseapp.com",
    projectId: "rifas-con-causa",
    storageBucket: "rifas-con-causa.appspot.com",
    messagingSenderId: "347417635634",
    appId: "1:347417635634:web:3ddab8921d26707910452b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);
  let datosBoletos = [];

  async function cargarBoletos() {
    const querySnapshot = await getDocs(collection(db, "BoletosRifa"));
    datosBoletos = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    const tbody = document.querySelector("#tablaBoletos tbody");
    tbody.innerHTML = "";

    datosBoletos.forEach(b => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${b.boleto}</td>
        <td>${b.nombre || ""}</td>
        <td>${b.telefono || ""}</td>
        <td>${b.estado || ""}</td>
        <td>${b.fecha ? new Date(b.fecha.seconds * 1000).toLocaleString().slice(0, 16) : ""}</td>
        <td>
          <select id="forma-${b.id}">
            <option disabled ${!b.formaPago ? "selected" : ""}>üßæ Elige forma de pago...</option>
            <option value="Efectivo" ${b.formaPago === "Efectivo" ? "selected" : ""}>Efectivo</option>
            <option value="Transferencia o deposito Spin OXXO 6160" ${b.formaPago === "Transferencia o deposito Spin OXXO 6160" ? "selected" : ""}>Transferencia o deposito Spin OXXO 6160</option>
            <option value="Otro" ${b.formaPago === "Otro" ? "selected" : ""}>Otro</option>
          </select>
        </td>
        <td>
          <select id="estado-${b.id}">
            <option disabled ${!b.estado ? "selected" : ""}>üîÑ Cambiar el status del boleto...</option>
            <option value="libre" ${b.estado === "libre" ? "selected" : ""}>Libre</option>
            <option value="apartado" ${b.estado === "apartado" ? "selected" : ""}>Apartado</option>
            <option value="pagado" ${b.estado === "pagado" ? "selected" : ""}>Pagado</option>
          </select>
        </td>
        <td>
          <button onclick="guardarAccion('${b.id}')">üíæ Guardar</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  window.guardarAccion = async function(id) {
    const forma = document.getElementById(`forma-${id}`).value;
    const estado = document.getElementById(`estado-${id}`).value;

    if (!forma || !estado) {
      alert("‚ö†Ô∏è Debes elegir forma de pago y estado.");
      return;
    }

    try {
      await updateDoc(doc(db, "BoletosRifa", id), {
        formaPago: forma,
        estado: estado,
        fecha: serverTimestamp()
      });
      alert("‚úÖ Guardado correctamente.");
      cargarBoletos();
    } catch (error) {
      console.error("‚ùå Error al guardar:", error);
      alert("Ocurri√≥ un error al guardar.");
    }
  };

  cargarBoletos();

    <script>
function generarBoleto(nombre, poblacion, folio, oportunidades, telefono) {
  // Crear elemento temporal
  const div = document.createElement("div");
  div.id = "boletoRecibo";
  div.style = `
    width: 300px;
    padding: 20px;
    border: 2px solid #000;
    text-align: center;
    font-family: Arial;
    background: #f8f9fa;
  `;
  div.innerHTML = `
    <h3>üéüÔ∏è Boleto de Rifa</h3>
    <p><strong>Nombre:</strong> ${nombre}</p>
    <p><strong>Poblaci√≥n:</strong> ${poblacion}</p>
    <p><strong>Folio:</strong> ${folio}</p>
    <p><strong>Oportunidades:</strong><br>${oportunidades.join(", ")}</p>
    <p style="margin-top:15px;">¬°Gracias por apoyar la causa!</p>
  `;
  document.body.appendChild(div);

  html2canvas(div).then(canvas => {
    const link = document.createElement("a");
    link.download = `BOLETO-${folio}.png`;
    link.href = canvas.toDataURL();
    link.click();
    document.body.removeChild(div);
  });
}
  </script>
</body>
</html>
