<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Panel Admin - Rifas con Causa</title>
 <style>
#contadorActualizacion {
  position: fixed;
  top: 10px;
  right: 20px;
  background: #e0f7fa;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: bold;
  color: #00796b;
  z-index: 9999;
  display: none;
}
</style>

<link href="favicon.ico" rel="icon" type="image/x-icon"/>
 <style>
#contadorActualizacion {
  position: fixed;
  top: 10px;
  right: 20px;
  background: #def7fa;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: bold;
  color: #08796b;
  z-index: 9999;
  display: none;
  transition: background 0.3s, color 0.3s;
}
#contadorActualizacion.alarma {
  background: #ff4d4d;
  color: white;
}
</style>

</head>
<body>
 <div id="contadorActualizacion">Actualizaci√≥n en: 40s</div>

<h1 id="tituloPanel">Panel de Control</h1>
<p style="font-size: 0.95em; margin-top: -10px; margin-bottom: 20px; line-height: 1.4; color: #333;">
‚ö†Ô∏è <strong>INSTRUCCIONES IMPORTANTES PARA LOS ROLES:</strong><br/>
‚Ä¢ Toma en cuenta que al cambiar un estado a <strong>"PAGADO"</strong>, <u>ya no podr√°s devolverlo a otro estado</u>.<br/>
‚Ä¢ Deber√°s comunicarte con el <strong>ADMIN</strong> para que realice la correcci√≥n si fue un error.<br/>
‚Ä¢ Y recuerda que si el cliente paga por <strong>transf. o deposito a la cuenta del admin</strong>,<br/>
el cambio de estado <u>debe hacerlo el ADMIN</u>,<br/>
ya que ese monto no entrar√° a tu cuenta de ingresos.
</p>
<button class="solo-admin" onclick="exportarExcelConResumen(boletos)" style="margin-top: 15px; display: none;">
  üìä Exportar reporte completo
</button>
<div class="solo-admin" style="margin-top: 10px; display: none;">
<label for="precioUnitario"><strong>üí∞ Precio unitario por boleto:</strong></label>
<input id="precioUnitario" min="0" step="1" style="width: 100px;" type="number" value="0"/>
</div><table border="1" id="tablaBoletos">
<thead>
<tr>
<th>Boleto</th>
<th>Nombre</th>
<th>Tel√©fono</th>
<th>Poblaci√≥n</th>
<th>Estado</th>
<th>Fecha</th>
<th>Modificado por</th>
<th>Forma Pago</th>
<th>Acci√≥n</th>
<th>Comprobante</th>
</tr>
</thead>
<tbody></tbody>
</table>
 <!-- Espacio extra para margen inferior -->
<div style="height: 80px;"></div>

<script type="module">
if (!location.origin.includes("https://rifas-con-causa.github.io")) {
  alert("‚ö†Ô∏è Est√°s abriendo este archivo fuera del entorno web oficial. Algunas funciones como subida de archivos no funcionar√°n correctamente.\n\nPor favor, accede desde:\nhttps://rifas-con-causa.github.io/BICIS-MONTANA-EQUIPADAS/panel-admin.html");
}

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs";

const firebaseConfig = {
  apiKey: "AIzaSyC-9BVF6sfbA1IcmawTtxFiwHOyHv0Qa3g",
  authDomain: "rifas-con-causa.firebaseapp.com",
  projectId: "rifas-con-causa",
  storageBucket: "rifas-con-causa.firebasestorage.app",
  messagingSenderId: "347417635634",
  appId: "1:347417635634:web:3ddab8921d26707910452b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage();

window.archivoSeleccionado = {};
let rolActivo = "";
let datosBoletos = [];

const cuentasOficiales = [
  "Transferencia o deposito Spin OXXO 6162"
];

const opcionesFormaPago = [
  "Efectivo",
  ...cuentasOficiales,
  "Otro"
];

let tiempoRestante = 180;
const contador = document.getElementById("contadorActualizacion");

setInterval(() => {
  const activo = document.activeElement;
  const esEditable = activo && (activo.tagName === 'INPUT' || activo.tagName === 'SELECT' || activo.tagName === 'TEXTAREA');

  tiempoRestante--;

  if (tiempoRestante <= 40) {
    contador.style.display = "block";
    contador.textContent = esEditable ? "‚è∏Ô∏è Editando..." : `Actualizaci√≥n en: ${tiempoRestante}s`;
  }

  if (tiempoRestante <= 0) {
    if (!esEditable) {
      cargarBoletos();
      console.log("üîÅ Tabla actualizada autom√°ticamente");
    } else {
      console.log("‚è∏Ô∏è Pausa: el usuario est√° interactuando");
    }
    tiempoRestante = 180;
    contador.style.display = "none";
  }
}, 1000);
 

window.cargarBoletos = cargarBoletos;
window.subirComprobante = subirComprobante;

async function cambiarEstado(id, estado) {
  const forma = document.getElementById("forma-" + id).value;
  if (estado === "pagado") {
    if (!forma || forma.includes("elige")) {
      alert("‚ö†Ô∏è Primero selecciona una forma de pago v√°lida.");
      return;
    }
    const confirmacion = confirm("¬øEst√°s seguro de marcar este boleto como pagado?");
    if (!confirmacion) return;
  }
  try {
    await updateDoc(doc(db, "BoletosRifa", id), {
      formaPago: forma,
      estado: estado,
      modificadoPor: rolActivo,
      fecha: serverTimestamp()
    });
    cargarBoletos();
  } catch (error) {
    console.error("‚ùå Error al guardar:", error);
    alert("‚ùå Ocurri√≥ un error al guardar.");
  }
}


async function cargarBoletos() {
  const querySnapshot = await getDocs(collection(db, "BoletosRifa"));
  datosBoletos = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  const tbody = document.querySelector("#tablaBoletos tbody");
  tbody.innerHTML = "";

  datosBoletos.forEach(b => {
    const rowColor = b.estado === "pagado"
      ? "style='background:#e74c3c; color:white'"
      : (b.estado === "apartado"
        ? "style='background:#f1c40f;'"
        : "style='background:#2ecc71; color:white'");

    tbody.innerHTML += `
      <tr ${rowColor}>
        <td>${b.boleto}</td>
        <td>${b.nombre}</td>
        <td>${b.telefono}</td>
        <td>${b.poblacion}</td>
        <td>${b.estado}</td>
        <td>${b.fecha ? new Date(b.fecha.seconds * 1000).toLocaleString().slice(0, 16) : ""}</td>
        <td>${b.modificadoPor || ""}</td>
        <td>${b.formaPago || ""}</td>
        <td>
          <select id="forma-${b.id}" style="margin-bottom:5px;">
            <option disabled selected>üßæ Elige forma de pago...</option>
            ${opcionesFormaPago.map(op => `<option value="${op}">${op}</option>`).join("")}
          </select><br>
          <select id="estado-${b.id}" onchange="cambiarEstado('${b.id}', this.value)">
            <option disabled selected>üîÑ Cambiar status del boleto...</option>
            <option value="libre">Libre</option>
            <option value="apartado">Apartado</option>
            <option value="pagado">Pagado</option>
          </select>
        </td>
        <td id="celda-${b.id}">
          <label for="file-${b.id}" style="cursor:pointer; background:#2980b9; color:white; padding:4px 8px; border-radius:4px; display:inline-block; font-size:0.85em;">üìé Subir comprobante</label>
          <input type="file" accept="image/*" id="file-${b.id}" style="display:none;"
                 onchange="document.getElementById('celda-${b.id}').style.backgroundColor = '#ffeaa7'; 
                            window.archivoSeleccionado['${b.id}'] = this.files[0]; 
                            subirComprobante('${b.id}', this.files[0]);">
          ${b.comprobanteUrl ? '<br>‚úÖ <a href="' + b.comprobanteUrl + '" target="_blank" style="font-size:0.85em;">üìÑ Ver</a>' : ''}
        </td>
      </tr>
    `;
  });
}

async function subirComprobante(id, archivo) {
  if (!archivo) return;
  const extension = archivo.name.split('.').pop();
  const storageRef = ref(storage, `comprobantes/boletos/${id}.${extension}`);
  try {
    await uploadBytes(storageRef, archivo);
    const url = await getDownloadURL(storageRef);
    await updateDoc(doc(db, "BoletosRifa", id), { comprobanteUrl: url });
    cargarBoletos();
  } catch (e) {
    console.error("‚ùå Error al subir comprobante:", e);
    alert("Error al subir comprobante. Intenta de nuevo.");
  }
}

window.exportarExcelConResumen = function exportarExcelConResumen(datosBoletos) {
  const wb = XLSX.utils.book_new();
  const precio = parseFloat(document.getElementById("precioUnitario").value);
  if (!precio || precio <= 0) return alert("‚ö†Ô∏è Ingresa un precio v√°lido para calcular los totales.");

  const porEstado = (estado) => datosBoletos.filter(b => b.estado === estado);
  const porPago = (tipo) => datosBoletos.filter(b => b.formaPago?.includes(tipo));

  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(datosBoletos), "Todos");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(porEstado("libre")), "Disponibles");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(porEstado("apartado")), "Apartados");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(porEstado("pagado")), "Pagados");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(porPago("6162")), "Pagados SPIN");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(porPago("Efectivo")), "Pagados Efectivo");

  const resumen = {};
  datosBoletos.forEach(b => {
    const rol = b.modificadoPor || "(sin rol)";
    resumen[rol] = (resumen[rol] || 0) + 1;
  });
  const resumenFinal = Object.keys(resumen).map(rol => ({
    Rol: rol,
    "Boletos Modificados": resumen[rol],
    "Total Calculado": "$" + (resumen[rol] * precio).toFixed(2)
  }));

  const efectivoRol = {};
  datosBoletos.forEach(b => {
    if (b.formaPago === "Efectivo") {
      const rol = b.modificadoPor || "(sin rol)";
      efectivoRol[rol] = (efectivoRol[rol] || 0) + 1;
    }
  });
  const tablaEfectivo = Object.entries(efectivoRol).map(([rol, cantidad]) => ({
    Rol: rol,
    "Boletos Efectivo": cantidad
  }));

  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(resumenFinal), "Resumen por Rol");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(tablaEfectivo), "Efectivo x Rol");
  XLSX.writeFile(wb, "reporte-completo-rifa.xlsx");
};
</script>


<!-- Script para generar imagen -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
function generarBoleto(nombre, poblacion, folio, oportunidades, telefono) {

  document.getElementById("nombreBoleto").innerText = nombre;
  document.getElementById("poblacionBoleto").innerText = poblacion;
  document.getElementById("folioBoleto").innerText = "BOLETO # " + folio;
  document.getElementById("lineaOport1").innerText = oportunidades.slice(0, 5).join("   ");
  document.getElementById("lineaOport2").innerText = oportunidades.slice(5, 10).join("   ");

  const boleto = document.getElementById("boletoPreview");
  boleto.style.display = "block";

  html2canvas(boleto, { useCORS: true }).then(canvas => {
    const link = document.createElement("a");
    link.download = `BOLETO-${folio}.png`;
    link.href = canvas.toDataURL();
    link.click();
    boleto.style.display = "none";

    // WhatsApp link
    const mensaje = `üéâ ¬°Gracias por apoyar la causa! Aqu√≠ tienes tu boleto #${folio} de la rifa de bicicletas.\n\n‚úÖ Participas con 10 oportunidades.\n\nM√°s informaci√≥n en: https://rifas-con-causa.github.io/BICIS-MONTANA-EQUIPADAS/index.html`;
    const numeroLimpio = telefono.replace(/\D/g, ""); // Solo n√∫meros

const waUrl = `https://wa.me/52${numeroLimpio}?text=${encodeURIComponent(mensaje)}`;

    document.getElementById("waLink").href = waUrl;
    document.getElementById("btnWhatsapp").style.display = "block";
   window.open(waUrl, "_blank");  // Esto abre autom√°ticamente el WhatsApp web

  });
}
</script>
<script>
// üé® Activar color rosa al editar y restaurar seg√∫n estado al salir
document.addEventListener("DOMContentLoaded", () => {
  const tabla = document.getElementById("tablaBoletos");

  tabla.addEventListener("focusin", (e) => {
    const tr = e.target.closest("tr");
    if (tr) {
      tr.setAttribute("data-original-color", tr.style.backgroundColor); // opcional
      tr.style.background = "#ffe6f0"; // color rosa claro
      tr.style.color = "black";
    }
  });

  tabla.addEventListener("focusout", (e) => {
    const tr = e.target.closest("tr");
    const estado = tr?.querySelector("td:nth-child(5)")?.textContent?.toLowerCase();
    if (tr && estado) {
      switch (estado) {
        case "pagado":
          tr.style.background = "#e74c3c"; tr.style.color = "white";
          break;
        case "apartado":
          tr.style.background = "#f1c40f"; tr.style.color = "black";
          break;
        default:
          tr.style.background = "#2ecc71"; tr.style.color = "white";
      }
    }
  });
});
</script>

</body>
</html>
