<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rifa Bicis MontaÃ±a - Boletos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0 0 200px 0;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .barra-navegacion, .pie-de-pagina {
      width: 100%;
      text-align: center;
      background: #004aad;
      color: white;
      padding: 10px;
      font-weight: bold;
      font-size: 1.8em;
    }
    .instrucciones {
      text-align: center;
      padding: 10px;
      font-size: 1.15em;
      max-width: 600px;
    }
    .instrucciones p:last-child {
      font-size: 2.2em;
    }
    #boletosGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 8px;
      padding: 10px;
      width: 100%;
      max-width: 600px;
      margin-bottom: 160px;
    }
    .boletoCard {
      border: 2px solid #004aad;
      border-radius: 8px;
      padding: 5px;
      color: white;
      text-align: center;
      font-weight: bold;
    }
    .seriesGrid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 2px;
      margin-bottom: 5px;
    }
    .seriesGrid span {
      background: rgba(255,255,255,0.2);
      padding: 2px;
      border-radius: 4px;
      font-size: 0.7em;
    }
    @keyframes fadeOut {
      to {
        opacity: 0;
        visibility: hidden;
      }
    }
  </style>
</head>
<body>
  <div class="barra-navegacion">
    <a href="index.html" style="color:white; text-decoration:none;">Regresar a Inicio</a>
  </div>

  <h2>Rifa Bicis MontaÃ±a - Boletos</h2>
  <div class="instrucciones">
    <p>ğŸ”½ Da clic en un boleto verde para registrarlo. Tienes 4 horas para hacer el pago antes de que se libere de nuevo.</p>
<p>âœ… Verde = Disponible</p>
<p>ğŸŸ¡ Amarillo = Apartado</p>
<p>ğŸ”´ Rojo = Pagado</p>
<p>â¬œ Gris = Alguien lo estÃ¡ apartando âœ‹</p>
  </div>

  <div id="boletosGrid"></div>

  <div class="pie-de-pagina">
    <p>Gracias por apoyar esta causa. Tu apoyo impulsa la cultura del deporte y fortalece a nuestra comunidad.</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC-9BVF6sfbA1IcmawTtxFiwHOyHv0Qa3g",
      authDomain: "rifas-con-causa.firebaseapp.com",
      projectId: "rifas-con-causa",
      storageBucket: "rifas-con-causa.appspot.com",
      messagingSenderId: "347417635634",
      appId: "1:347417635634:web:3ddab8921d26707910452b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function limpiarBoletosCongelados() {
      const boletosRef = collection(db, "BoletosRifa");
      const querySnapshot = await getDocs(boletosRef);
      const ahora = new Date();
      for (const docSnap of querySnapshot.docs) {
        const data = docSnap.data();
        if (data.estado === "en_proceso" && data.timestamp?.toDate) {
          const creado = data.timestamp.toDate();
          const tiempoPasado = ahora - creado;
          if (tiempoPasado > 60000) {
            await updateDoc(doc(db, "BoletosRifa", docSnap.id), {
              estado: "libre",
              idTemporal: "",
              timestamp: serverTimestamp()
            });
            console.log(`ğŸ”“ Boleto ${docSnap.id} liberado automÃ¡ticamente`);
          }
        }
      }
    }

    async function cargarBoletos() {
      const querySnapshot = await getDocs(collection(db, "BoletosRifa"));
      const boletos = [];
      querySnapshot.forEach((doc) => boletos.push(doc.data()));
      boletos.sort((a, b) => parseInt(a.boleto) - parseInt(b.boleto));
      mostrarBoletos(boletos);
    }

    function mostrarBoletos(lista) {
      const grid = document.getElementById("boletosGrid");
      if (!grid) {
        console.error("âŒ No se encontrÃ³ el contenedor con id='boletosGrid'");
        return;
      }
      grid.innerHTML = "";
      lista.forEach((boleto) => {
        let color = "#2ecc71";
        if (boleto.estado === "apartado") color = "#f1c40f";
        if (boleto.estado === "pagado") color = "#e74c3c";
        if (boleto.estado === "en_proceso") color = "#95a5a6";
        const div = document.createElement("div");
        div.className = "boletoCard";
        div.style.backgroundColor = color;
        div.innerHTML = `
          <div class="seriesGrid">
            ${(boleto.series || ["01","02","03","04","05","06","07","08","09","10"]).map(num => `<span>${num}</span>`).join("")}
          </div>
          <h3>#${boleto.boleto}</h3>`;
        if (boleto.estado === "libre") {
          div.style.cursor = "pointer";
          div.addEventListener("click", async () => {
            div.style.backgroundColor = "#95a5a6";
            div.title = "â³ EN PROCESO DE APARTADO";
            div.style.cursor = "default";
            setTimeout(() => {
              window.location.href = `registro.html?boleto=${boleto.boleto}`;
            }, 100);
          });
          
        } else if (boleto.estado === "en_proceso") {
  div.title = "â³ EN PROCESO DE APARTADO";

  // â³ Agregamos aviso visual para mÃ³viles
  const aviso = document.createElement("div");
  aviso.innerText = "â³ En proceso...";
  aviso.style.fontSize = "0.7em";
  aviso.style.backgroundColor = "#555";
  aviso.style.color = "white";
  aviso.style.borderRadius = "5px";
  aviso.style.padding = "2px 5px";
  aviso.style.marginTop = "4px";
  aviso.style.display = "inline-block";
  div.appendChild(aviso);
}

        grid.appendChild(div);
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await limpiarBoletosCongelados();
      setTimeout(() => cargarBoletos(), 200);
      setTimeout(() => {
        const mensaje = document.createElement("div");
        mensaje.id = "bienvenidaPanel";
        mensaje.innerHTML = "<strong>âœ… BIENVENIDO.</strong><br>LOS BOLETOS VERDES ESTÃN DISPONIBLES.";
        mensaje.style = `
          position: absolute;
          top: 80px;
          left: 50%;
          transform: translateX(-50%);
          background-color: #2ecc71;
          color: white;
          padding: 20px 40px;
          border-radius: 12px;
          font-size: 1.5em;
          font-weight: bold;
          z-index: 9999;
          animation: fadeOut 0.5s ease-in-out 2.5s forwards;
          text-align: center;
        `;
        document.body.appendChild(mensaje);
        setTimeout(() => mensaje.remove(), 3000);
      }, 300);

      
    let enInteraccion = false;

document.addEventListener("mousedown", () => enInteraccion = true);
document.addEventListener("mouseup", () => enInteraccion = false);

setInterval(async () => {
  if (!enInteraccion) {
    console.log("ğŸ” Auto-refresh activado");

    try {
      await limpiarBoletosCongelados(); // âœ… Libera boletos grises
      await cargarBoletos();             // âœ… Actualiza la vista
    } catch (err) {
      console.error("âŒ Error en auto-refresh:", err);
    }

  } else {
    console.log("â¸ Auto-refresh pausado por interacciÃ³n");
  }
}, 75000); // â±ï¸ Cada 75 segundos

    });
  </script>

  <!-- ğŸ”½ AquÃ­ va el botÃ³n con el modal -->
  <button onclick="document.getElementById('modalBases').style.display='block'" style="margin: 40px; background:#27ae60; color:white; border:none; border-radius:30px; font-weight:bold; font-size:14px; cursor:pointer;">
    ğŸ“„ Bases del sorteo
  </button>
      <div id="modalBases" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
    <div style="background:white; max-width:1500px; margin:4% auto; padding:40px; border-radius:20px; box-shadow:0 6px 18px rgba(0,0,0,0.3); font-family:Arial;">

    <h3 style="margin-top:0; color:#2d72d3;">ğŸ“œ Bases del sorteo</h3>
      <ul style="padding-left:20px; line-height:1.5;">
        <li>ğŸ” Si el nÃºmero ganador no fue pagado, la rifa se repite en un mÃ¡ximo de 8 dÃ­as.</li>
        <li>ğŸ“… Si no se vendiÃ³ el 80%, se puede reprogramar hasta por 15 dÃ­as mÃ¡s.</li>
        <li>ğŸ’³ LA CUENTA DE PAGOS  Spin OXXO: 4217 4701 5601 6160â€ƒCLABE: 7289 6900 0143 3179 21</li>
        <li>ğŸ“² Los comprobantes de pago son al WhatsApp 3311571619 o tu promotor te registrarÃ¡ tu boleto</li>
      </ul>
      <p style="margin-top:20px; font-style:italic; color:#555;">*Gracias. Nuestra misiÃ³n: transparencia, respeto y calidad.*</p>
      <button onclick="document.getElementById('modalBases').style.display='none'" style="margin-top:10px; background:#e53935; color:white; border:none; padding:8px 16px; border-radius:20px; font-weight:bold; cursor:pointer;">Cerrar</button>
    </div>
  </div>

</body>
</html>
