
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    doc,
    updateDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-9BVF6sfbA1IcmawTtxFiwHOyHv0Qa3g",
    authDomain: "rifas-con-causa.firebaseapp.com",
    projectId: "rifas-con-causa",
    storageBucket: "rifas-con-causa.appspot.com",
    messagingSenderId: "347417635634",
    appId: "1:347417635634:web:3ddab8921d26707910452b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function limpiarBoletosCongelados() {
    const boletosRef = collection(db, "BoletosRifa");
    const querySnapshot = await getDocs(boletosRef);
    const ahora = new Date();

    for (const docSnap of querySnapshot.docs) {
      const data = docSnap.data();
      if (data.estado === "en_proceso" && data.timestamp?.toDate) {
        const creado = data.timestamp.toDate();
        const tiempoPasado = ahora - creado;

        if (tiempoPasado > 30000) {
          await updateDoc(doc(db, "BoletosRifa", docSnap.id), {
            estado: "libre",
            idTemporal: "",
            timestamp: serverTimestamp()
          });
          console.log(`🔓 Boleto ${docSnap.id} liberado automáticamente`);
        }
      }
    }
  }

  async function cargarBoletos() {
    const querySnapshot = await getDocs(collection(db, "BoletosRifa"));
    const boletos = [];
    querySnapshot.forEach((doc) => boletos.push(doc.data()));
    boletos.sort((a, b) => parseInt(a.boleto) - parseInt(b.boleto));
    mostrarBoletos(boletos);
  }

  function mostrarBoletos(lista) {
    const grid = document.getElementById("boletosGrid");
    grid.innerHTML = "";

    lista.forEach((boleto) => {
      let color = "#2ecc71";
      if (boleto.estado === "apartado") color = "#f1c40f";
      if (boleto.estado === "pagado") color = "#e74c3c";
      if (boleto.estado === "en_proceso") color = "#95a5a6";

      const div = document.createElement("div");
      div.className = "boletoCard";
      div.style.backgroundColor = color;
      div.innerHTML = `
        <div class="seriesGrid">
          ${(boleto.series || ["01","02","03","04","05","06","07","08","09","10"])
            .map(num => `<span>${num}</span>`).join("")}
        </div>
        <h3>#${boleto.boleto}</h3>
      `;

      if (boleto.estado === "libre") {
        div.style.cursor = "pointer";
        div.addEventListener("click", () => {
          window.location.href = \`registro.html?boleto=\${boleto.boleto}\`;
        });
      } else if (boleto.estado === "en_proceso") {
        div.title = "⏳ EN PROCESO DE APARTADO";
      }

      grid.appendChild(div);
    });
  }

  document.addEventListener("DOMContentLoaded", async () => {
    await limpiarBoletosCongelados();
    setTimeout(() => cargarBoletos(), 200);

    // ✅ Mensaje flotante de bienvenida
    setTimeout(() => {
      const mensaje = document.createElement("div");
      mensaje.id = "bienvenidaPanel";
      mensaje.innerHTML = "<strong>✅ BIENVENIDO.</strong><br>LOS BOLETOS VERDES ESTÁN DISPONIBLES.";
      mensaje.style = \`
        position: absolute;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #2ecc71;
        color: white;
        padding: 20px 40px;
        border-radius: 12px;
        font-size: 1.5em;
        font-weight: bold;
        z-index: 9999;
        animation: fadeOut 0.5s ease-in-out 2.5s forwards;
        text-align: center;
      \`;
      document.body.appendChild(mensaje);
      setTimeout(() => mensaje.remove(), 3000);
    }, 300);
  });
</script>

<style>
  @keyframes fadeOut {
    to {
      opacity: 0;
      visibility: hidden;
    }
  }
</style>
