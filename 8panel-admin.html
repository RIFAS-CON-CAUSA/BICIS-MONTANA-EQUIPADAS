
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Admin - Rifas con Causa V17.4 PRO</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC-9BVF6sfbA1IcmawTtxFiwHOyHv0Qa3g",
      authDomain: "rifas-con-causa.firebaseapp.com",
      projectId: "rifas-con-causa",
      storageBucket: "rifas-con-causa.appspot.com",
      messagingSenderId: "347417635634",
      appId: "1:347417635634:web:3ddab8921d26707910452b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    async function cargarBoletos() {
      const snapshot = await getDocs(collection(db, "BoletosRifa"));
      const tbody = document.getElementById("tablaBoletos");
      tbody.innerHTML = "";
      snapshot.forEach(docSnap => {
        const b = docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>#${b.boleto}</td>
          <td>${b.nombre || ""}</td>
          <td>${b.telefono || ""}</td>
          <td>${b.poblacion || ""}</td>
          <td class="${b.estado}">${b.estado}</td>
          <td>${b.fecha ? new Date(b.fecha).toLocaleString() : ""}</td>
          <td>
            <select onchange="cambiarEstado('${docSnap.id}', this.value, ${JSON.stringify(b)})">
              <option disabled selected>Seleccionar</option>
              <option value="libre">Libre</option>
              <option value="apartado">Apartado</option>
              <option value="pagado">Pagado</option>
            </select>
          </td>
          <td>${b.modificadoPor || ""}</td>
          <td>${b.formaPago || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.cambiarEstado = async (idDoc, nuevoEstado, boletoData) => {
      const formaPago = nuevoEstado === "pagado" ? prompt("Forma de pago:") : "";
      const modificadoPor = prompt("¬øQui√©n realiza el cambio?");

      const refDoc = doc(db, "BoletosRifa", idDoc);
      await updateDoc(refDoc, {
        estado: nuevoEstado,
        formaPago: formaPago,
        modificadoPor: modificadoPor,
        fecha: new Date().toISOString()
      });

      if (nuevoEstado === "pagado") {
        const urlBoleto = await generarYSubirBoleto(boletoData);
        await updateDoc(refDoc, { urlBoleto: urlBoleto });

        const mensaje = `Hola ${boletoData.nombre}! üéâ

Recuerda que puedes ganar el 3er Premio VIP (Bicicleta Mercurio 26 üö≤) si resultas ganador del sorteo principal y:
‚úÖ Compras 2 boletos m√°s.
‚úÖ Compartes la rifa en Facebook.
‚úÖ Anotas tu serie en la publicaci√≥n.

üì¶ Adem√°s incluye Env√≠o GRATIS a todo M√©xico.

üîó Aqu√≠ tienes tu boleto digital: ${urlBoleto}
Guarda captura, ¬°es tu pase al regalo!`;

        const whatsappURL = `https://wa.me/52${boletoData.telefono}?text=${encodeURIComponent(mensaje)}`;
        window.open(whatsappURL, "_blank");
      }

      cargarBoletos();
    };

    async function generarYSubirBoleto(b) {
      const div = document.createElement("div");
      div.style.width = "400px";
      div.style.padding = "20px";
      div.style.border = "2px solid green";
      div.style.textAlign = "center";
      div.style.background = "#ffffff";
      div.innerHTML = `
        <h2>Boleto #${b.boleto}</h2>
        <p><strong>Nombre:</strong> ${b.nombre}</p>
        <p><strong>Tel√©fono:</strong> ${b.telefono}</p>
        <p><strong>Series:</strong> ${b.series.join(", ")}</p>
        <p style="font-size: 12px; margin-top: 10px; color: #555;">üéÅ Premio VIP adicional:<br>Si resultas ganador:<br>- Compra 2 boletos m√°s<br>- Comparte en Facebook<br>- Anota tu serie<br>- ¬°Env√≠o Gratis!</p>
        <p style="font-size: 10px; margin-top: 5px;">Fecha: ${new Date().toLocaleString()}</p>
      `;

      document.body.appendChild(div);
      const canvas = await html2canvas(div);
      const dataURL = canvas.toDataURL("image/png");
      document.body.removeChild(div);

      const storageRef = ref(storage, `boletos/${b.boleto}.png`);
      await uploadString(storageRef, dataURL, 'data_url');

      const url = await getDownloadURL(storageRef);
      return url;
    }

    cargarBoletos();
  </script>
  <style>
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    .libre { background: #00aa00; color: white; }
    .apartado { background: #ffbb00; color: black; }
    .pagado { background: #cc0000; color: white; }
  </style>
</head>
<body>
  <h2>Panel Administrativo - Rifas con Causa V17.4 PRO</h2>
  <table>
    <thead>
      <tr>
        <th>Boleto</th>
        <th>Nombre</th>
        <th>Tel√©fono</th>
        <th>Poblaci√≥n</th>
        <th>Estado</th>
        <th>Fecha</th>
        <th>Cambiar Estado</th>
        <th>Modificado por</th>
        <th>Forma de pago</th>
      </tr>
    </thead>
    <tbody id="tablaBoletos"></tbody>
  </table>
</body>
</html>
