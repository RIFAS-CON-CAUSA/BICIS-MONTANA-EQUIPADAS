<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Boletos Rifa - Bicis</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5dc; padding: 20px; }

    .boleto {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      margin: 5px;
      width: 160px;
      display: inline-block;
      vertical-align: top;
      text-align: center;
      background: #e0ffe0;
    }

    .apartado { background: #fff176; }  /* Amarillo */
    .pagado { background: #81c784; }    /* Verde */

    button { margin-top: 5px; }

    #filtro { margin-bottom: 20px; }

    /* Responsive: 3 boletos por línea en móviles */
    @media (max-width: 600px) {
      .boleto {
        width: calc(33.33% - 20px);
        box-sizing: border-box;
      }
    }
  </style>
</head>
<body>

<h2>Panel de Boletos - Rifa Bicis</h2>

<div>
  <label for="filtro">Filtrar por estado: </label>
  <select id="filtro" onchange="filtrarBoletos()">
    <option value="todos">Todos</option>
    <option value="disponible">Disponible</option>
    <option value="apartado">Apartado</option>
    <option value="pagado">Pagado</option>
  </select>
</div>

<div id="boletos-container"></div>

<button onclick="descargarReporte()">Descargar Reporte Excel</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, doc, getDocs, updateDoc, collection } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "tu-api-key",
    authDomain: "tu-proyecto.firebaseapp.com",
    projectId: "tu-proyecto",
    storageBucket: "tu-proyecto.appspot.com",
    messagingSenderId: "tu-sender-id",
    appId: "tu-app-id"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let datosBoletos = [];

  async function cargarBoletos() {
    const container = document.getElementById('boletos-container');
    container.innerHTML = "";

    const querySnapshot = await getDocs(collection(db, "boletos"));
    datosBoletos = [];

    querySnapshot.forEach((docSnap) => {
      const data = docSnap.data();
      data.docId = docSnap.id;
      datosBoletos.push(data);
    });

    pintarBoletos(datosBoletos);
  }

  function pintarBoletos(lista) {
    const container = document.getElementById('boletos-container');
    container.innerHTML = "";

    lista.forEach(data => {
      let numerosOrdenados = (data.numeros || []).sort((a, b) => parseInt(a) - parseInt(b));

      const div = document.createElement('div');
      div.className = 'boleto';
      div.id = `boleto-${data.idboleto}`;

      if (data.estado === "apartado") div.classList.add('apartado');
      if (data.estado === "pagado") div.classList.add('pagado');

      div.innerHTML = `
        <strong>Boleto #${data.idboleto}</strong><br>
        <small>${numerosOrdenados.join(' - ')}</small><br>
        <small>${data.nombre || 'Disponible'}</small><br>
        <small>Pago: ${data.pago || '-'}</small><br>
        <small>Modificado por: ${data.modificadoPor || '-'}</small><br>
        ${data.estado === "pagado" ? '<button disabled>Pagado</button>' : `
        <button onclick="cambiarEstado('${data.docId}', 'apartado')">Apartar</button>
        <button onclick="cambiarEstado('${data.docId}', 'pagado')">Pagar</button>`}
      `;

      container.appendChild(div);
    });
  }

  async function cambiarEstado(docId, nuevoEstado) {
    const nombreUsuario = prompt("¿Quién realiza este cambio? (Ej: Miriam, Patty)");
    const metodoPago = nuevoEstado === "pagado" ? prompt("Forma de pago: Efectivo o Transferencia") : "";

    await updateDoc(doc(db, "boletos", docId), {
      estado: nuevoEstado,
      modificadoPor: nombreUsuario,
      pago: metodoPago
    });

    alert(`Boleto actualizado a ${nuevoEstado}`);
    cargarBoletos();
  }

  function filtrarBoletos() {
    const valor = document.getElementById('filtro').value;
    if (valor === "todos") {
      pintarBoletos(datosBoletos);
    } else {
      const filtrados = datosBoletos.filter(b => (b.estado || "disponible") === valor);
      pintarBoletos(filtrados);
    }
  }

  function descargarReporte() {
    let csvContent = "data:text/csv;charset=utf-8,Boleto,Estado,Nombre,ModificadoPor,FormaPago\n";

    datosBoletos.forEach(b => {
      csvContent += `${b.idboleto},${b.estado || 'disponible'},${b.nombre || ''},${b.modificadoPor || ''},${b.pago || ''}\n`;
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "reporte_rifa_bicis.csv");
    document.body.appendChild(link);
    link.click();
  }

  cargarBoletos();
</script>

</body>
</html>
