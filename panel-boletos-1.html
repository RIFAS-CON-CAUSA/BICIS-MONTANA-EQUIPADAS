<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Boletos - Rifa</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5dc; padding: 20px; margin: 0; }

    .header { margin-bottom: 10px; text-align: center; }
    .boton { padding: 10px 15px; background: #4CAF50; color: white; text-decoration: none; border-radius: 5px; margin: 5px; display: inline-block; }

    .buscador-barra {
      position: sticky;
      top: 0;
      background: #f5f5dc;
      padding: 10px;
      text-align: right;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 999;
    }

    .buscador-barra input { padding: 5px; width: 180px; border-radius: 5px; border: 1px solid #ccc; }
    .buscador-barra button { padding: 6px 10px; margin-left: 5px; }

    .boleto {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      margin: 5px;
      width: 160px;
      display: inline-block;
      text-align: center;
      background: #e0ffe0;
    }

    .apartado { background: #fff176 !important; }
    .pagado { background: #f44336 !important; color: white; }

    .bnr { margin-top: 20px; text-align: center; }
    .footer { margin-top: 30px; text-align: center; }

    @media (max-width: 600px) {
      .boleto { width: calc(33.33% - 20px); }
    }
  </style>
</head>
<body>

<div class="header">
  <h2>ðŸ“‹ Panel de Boletos - Rifa</h2>
</div>

<div class="buscador-barra">
  <input type="text" id="busquedaNumero" placeholder="Buscar tu nÃºmero...">
  <button onclick="buscarNumero()">Buscar</button>
  <button onclick="mostrarBNR()">ðŸ”’ BNR</button>
  <a href="registro.html" class="boton">+ Registrar Boleto</a>
</div>

<div id="boletos-container">Cargando boletos...</div>

<div class="bnr" id="bnr-container" style="display:none;">
  <h3>NÃºmeros Repetidos</h3>
  <div id="bnr-result">---</div>
</div>

<div class="footer">
  <a href="index.html" class="boton">â¬… Volver al inicio</a>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-9BVF6sfbA1IcmawTtxFiwHOyHv0Qa3g",
    authDomain: "rifas-con-causa.firebaseapp.com",
    projectId: "rifas-con-causa",
    storageBucket: "rifas-con-causa.firebasestorage.app",
    messagingSenderId: "347417635634",
    appId: "1:347417635634:web:3ddab8921d26707910452b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let datosBoletos = [];
async function cargarBoletos() {
    const container = document.getElementById('boletos-container');
    container.innerHTML = "Cargando...";

    const querySnapshot = await getDocs(collection(db, "boletos"));
    datosBoletos = [];

    querySnapshot.forEach((docSnap) => {
      const data = docSnap.data();
      data.docId = docSnap.id;
      datosBoletos.push(data);
    });

    datosBoletos.sort((a, b) => parseInt(a.idboleto || a.docId || 0) - parseInt(b.idboleto || b.docId || 0));
    pintarBoletos(datosBoletos);
  }

  function pintarBoletos(lista) {
    const container = document.getElementById('boletos-container');
    container.innerHTML = "";

    lista.forEach(data => {
      const idboleto = data.idboleto || data.docId || 'Sin nÃºmero';
      const numeros = Array.isArray(data.numeros) ? data.numeros.map(n => String(n)) : [];
      const numerosOrdenados = numeros.sort((a, b) => parseInt(a) - parseInt(b));

      const div = document.createElement('div');
      div.className = 'boleto';
      if (data.estado === "apartado") div.classList.add('apartado');
      if (data.estado === "pagado") div.classList.add('pagado');

      div.innerHTML = `
        <strong>Boleto #${idboleto}</strong><br>
        <small>${numerosOrdenados.length > 0 ? numerosOrdenados.join(' - ') : 'Sin nÃºmeros'}</small>
      `;

      container.appendChild(div);
    });
  }

  function buscarNumero() {
    const valor = document.getElementById('busquedaNumero').value.trim();
    if (!valor) {
      pintarBoletos(datosBoletos);
      return;
    }

    const filtrados = datosBoletos.filter(b => {
      const numeros = Array.isArray(b.numeros) ? b.numeros.map(n => String(n)) : [];
      return numeros.some(num => num.includes(valor));
    });

    pintarBoletos(filtrados);
  }

  function mostrarBNR() {
    const clave = prompt("Introduce la clave para ver el BNR:");
    if (clave !== "admin2024") {
      alert("Clave incorrecta.");
      return;
    }

    const contador = {};
    datosBoletos.forEach(b => {
      (b.numeros || []).forEach(num => {
        const n = String(num);
        contador[n] = (contador[n] || 0) + 1;
      });
    });

    const repetidos = Object.entries(contador)
      .filter(([num, count]) => count > 1)
      .map(([num]) => num);

    const resultado = repetidos.length > 0 ? repetidos.join(', ') : "No hay nÃºmeros repetidos.";
    document.getElementById('bnr-result').textContent = resultado;
    document.getElementById('bnr-container').style.display = 'block';
  }

  cargarBoletos();
</script>
</body>
</html>