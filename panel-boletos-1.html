<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>RIFA ‚Äì Elige tu boleto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fddf;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1 {
      color: #1b5e20;
      font-size: 24px;
    }
    #volverInicio {
      display: inline-block;
      margin: 10px auto;
      padding: 10px 20px;
      background-color: #1b5e20;
      color: white;
      border-radius: 20px;
      text-decoration: none;
      font-weight: bold;
    }
    .instrucciones {
      font-size: 15px;
      margin: 15px 0;
    }
    #busqueda, #btnBuscar {
      padding: 10px;
      font-size: 14px;
      margin: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #btnBuscar {
      background-color: #1565c0;
      color: white;
      border: none;
    }
    #panel {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
      max-width: 1000px;
      margin: auto;
    }
    .boleto {
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      border: 2px solid #ccc;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .numeros {
      font-size: 13px;
      color: #444;
      margin-bottom: 8px;
    }
    button {
      padding: 10px;
      border: none;
      color: white;
      font-weight: bold;
      font-size: 15px;
      border-radius: 8px;
      width: 100%;
      cursor: pointer;
    }
    .disponible { background-color: #2ecc71; }
    .apartado { background-color: #f1c40f; }
    .pagado { background-color: #e74c3c; }

    #reporteRepetidos, #reporteBusqueda {
      margin-top: 20px;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 15px;
      border-radius: 10px;
      font-size: 14px;
      display: none;
    }
    #btnBNR {
      font-size: 10px;
      background-color: transparent;
      border: none;
      color: #444;
      text-decoration: underline;
      cursor: pointer;
    }
    .mensaje-final {
      margin-top: 30px;
      font-weight: bold;
      font-size: 15px;
      color: #333;
    }
  </style>
</head>
<body>

<a id="volverInicio" href="index.html">‚¨Ö Volver al inicio</a>
<button id="btnBNR" onclick="pedirClaveBNR()">BNR</button>

<h1>Aqu√≠ tienes los 100 boletos</h1>
<p class="instrucciones">
  <strong>RIFA ‚Äì Elige tu boleto</strong><br>
  <span style="color:#2ecc71;">üü© Verde</span>: Disponible &nbsp; 
  <span style="color:#f1c40f;">üü® Amarillo</span>: Apartado &nbsp; 
  <span style="color:#e74c3c;">üü• Rojo</span>: No disponible
</p>

<input id="busqueda" placeholder="Encuentra tu n√∫mero de la suerte üîç">
<button id="btnBuscar" onclick="buscarNumero()">Buscar</button>

<div id="panel"></div>

<a id="volverInicio" href="index.html">‚¨Ö Volver al inicio</a>

<div class="mensaje-final">
  Gracias por tu apoyo al deporte y los j√≥venes.<br>
  ¬°MUCHA SUERTE! Con un boleto ya est√°s dentro de los probables ganadores y nuevo ciclista.
</div>

<div id="reporteBusqueda"></div>
<div id="reporteRepetidos"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-9BVF6sfbA1IcmawTtxFiwHOyHv0Qa3g",
    authDomain: "rifas-con-causa.firebaseapp.com",
    projectId: "rifas-con-causa",
    storageBucket: "rifas-con-causa.appspot.com",
    messagingSenderId: "347417635634",
    appId: "1:347417635634:web:3ddab8921d26707910452b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const panel = document.getElementById("panel");
  const oportunidadesGlobal = [];

  async function construirBoletos() {
    for (let i = 1; i <= 100; i++) {
      const id = String(i).padStart(3, '0');
      const ref = doc(db, "boletos", id);
      const snap = await getDoc(ref);
      const data = snap.data();
      const estado = data?.estado || "disponible";
      const numeros = data?.numeros || [];

      const div = document.createElement("div");
      div.className = "boleto";

      const numsDiv = document.createElement("div");
      numsDiv.className = "numeros";
      numsDiv.textContent = numeros.join(" ¬∑ ");
      div.appendChild(numsDiv);

      for (let num of numeros) {
        oportunidadesGlobal.push({ num, boleto: id });
      }

      const btn = document.createElement("button");
      btn.textContent = `Boleto #${id}`;
      btn.className = estado.toLowerCase();
      btn.disabled = estado === "pagado";
      btn.onclick = () => window.location.href = `registro.html?boleto=${id}`;

      div.appendChild(btn);
      panel.appendChild(div);
    }
  }

  window.buscarNumero = () => {
    const input = document.getElementById("busqueda").value.trim();
    const reporte = document.getElementById("reporteBusqueda");
    if (!/^\d{3}$/.test(input)) {
      reporte.style.display = "block";
      reporte.innerHTML = "‚ö†Ô∏è Ingresa un n√∫mero de 3 d√≠gitos exactos (ej: 170)";
      return;
    }
    const resultado = oportunidadesGlobal.filter(o => o.num === input);
    if (resultado.length === 0) {
      reporte.style.display = "block";
      reporte.innerHTML = `‚ùå El n√∫mero <strong>${input}</strong> no aparece en ning√∫n boleto.`;
    } else {
      const boletos = resultado.map(r => `#${r.boleto}`);
      const texto = boletos.length === 1 
        ? `‚úÖ El n√∫mero <strong>${input}</strong> aparece en el siguiente boleto:<br>${boletos[0]}`
        : `‚úÖ El n√∫mero <strong>${input}</strong> aparece en los siguientes boletos:<br>${boletos.join(", ")}`;
      reporte.style.display = "block";
      reporte.innerHTML = texto;
    }
  };

  window.pedirClaveBNR = () => {
    const clave = prompt("Introduce la clave:");
    if (clave === "BNR") {
      const contador = {};
      for (let obj of oportunidadesGlobal) {
        contador[obj.num] = (contador[obj.num] || []);
        contador[obj.num].push(obj.boleto);
      }

      let repetidos = Object.entries(contador).filter(e => e[1].length > 1);
      let salida = "<h3>üîÅ N√∫meros repetidos:</h3><ul>";
      for (let [numero, boletos] of repetidos) {
        salida += `<li>${numero} ‚Üí Boletos: ${boletos.map(b => "#" + String(b).padStart(3, '0')).join(", ")}</li>`;
      }
      salida += "</ul>";
      const cont = document.getElementById("reporteRepetidos");
      cont.innerHTML = salida;
      cont.style.display = "block";
    } else {
      alert("Clave incorrecta.");
    }
  };

  construirBoletos();
</script>
</body>
</html>