<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Boletos - Rifa Bicis</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5dc; padding: 20px; }

    .header { margin-bottom: 20px; text-align: center; position: relative; }
    .boton { padding: 10px 15px; background: #4CAF50; color: white; text-decoration: none; border-radius: 5px; margin: 5px; display: inline-block; }

    .filtro { margin: 10px 0; text-align: center; }
    .agradecimiento { margin-top: 20px; font-weight: bold; font-size: 14px; text-align: center; }

    .buscador-bnr {
      position: absolute;
      top: 0;
      right: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .buscador-bnr input {
      padding: 5px;
      width: 150px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .bnr-link {
      cursor: pointer;
      color: #4CAF50;
      font-weight: bold;
      text-decoration: underline;
    }

    .boleto {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      margin: 5px;
      width: 160px;
      display: inline-block;
      vertical-align: top;
      text-align: center;
      background: #e0ffe0;
    }

    .apartado { background: #fff176 !important; }
    .pagado { background: #f44336 !important; }

    .bnr-container { margin-top: 30px; display: none; text-align: center; }
    .bnr-container.visible { display: block; }

    .footer { margin-top: 30px; text-align: center; }

    @media (max-width: 600px) {
      .boleto { width: calc(33.33% - 20px); box-sizing: border-box; }
      .buscador-bnr input { width: 100px; }
    }
  </style>
</head>
<body>

<div class="header">
  <h2>ðŸ“‹ AquÃ­ tienes los 100 boletos</h2>
  <div class="buscador-bnr">
    <input type="number" id="busquedaNumero" placeholder="Buscar tu nÃºmero..." oninput="buscarNumero()">
    <span class="bnr-link" onclick="mostrarBNR()">ðŸ”’ Ver BNR</span>
  </div>
</div>

<div class="filtro">
  <button class="boton" onclick="filtrar('disponible')">ðŸŸ© Disponible</button>
  <button class="boton" onclick="filtrar('apartado')">ðŸŸ¨ Apartado</button>
  <button class="boton" onclick="filtrar('pagado')">ðŸŸ¥ Pagado</button>
</div>

<div id="boletos-container">Cargando boletos...</div>

<div class="agradecimiento">
  Gracias por tu apoyo al deporte y los jÃ³venes. Â¡MUCHA SUERTE!
</div>

<div id="bnr-container" class="bnr-container">
  <h3>ðŸ”Ž NÃºmeros Repetidos</h3>
  <div id="bnr-result">Cargando...</div>
</div>

<div class="footer">
  <a href="index.html" class="boton">â¬… Volver al inicio</a>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-9BVF6sfbA1IcmawTtxFiwHOyHv0Qa3g",
    authDomain: "rifas-con-causa.firebaseapp.com",
    projectId: "rifas-con-causa",
    storageBucket: "rifas-con-causa.firebasestorage.app",
    messagingSenderId: "347417635634",
    appId: "1:347417635634:web:3ddab8921d26707910452b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let datosBoletos = [];
async function cargarBoletos() {
    const container = document.getElementById('boletos-container');
    container.innerHTML = "Cargando...";

    const querySnapshot = await getDocs(collection(db, "boletos"));
    datosBoletos = [];

    querySnapshot.forEach((docSnap) => {
      const data = docSnap.data();
      data.docId = docSnap.id;
      datosBoletos.push(data);
    });

    datosBoletos.sort((a, b) => parseInt(a.idboleto || a.docId || 0) - parseInt(b.idboleto || b.docId || 0));
    pintarBoletos(datosBoletos);
  }

  function pintarBoletos(lista) {
    const container = document.getElementById('boletos-container');
    container.innerHTML = "";

    lista.forEach(data => {
      const idboleto = data.idboleto || data.docId || 'Sin nÃºmero';
      const numeros = Array.isArray(data.numeros) ? data.numeros.map(n => String(n)) : [];
      const numerosOrdenados = numeros.sort((a, b) => parseInt(a) - parseInt(b));

      const div = document.createElement('div');
      div.className = 'boleto';
      if (data.estado === "apartado") div.classList.add('apartado');
      if (data.estado === "pagado") div.classList.add('pagado');

      div.innerHTML = `
        <strong>Boleto #${idboleto}</strong><br>
        <small>${numerosOrdenados.length > 0 ? numerosOrdenados.join(' - ') : 'Sin nÃºmeros'}</small>
      `;

      container.appendChild(div);
    });
  }

  function filtrar(estado) {
    const filtrados = datosBoletos.filter(b => (b.estado || "disponible") === estado);
    pintarBoletos(filtrados);
  }

  function buscarNumero() {
    const valor = document.getElementById('busquedaNumero').value.trim();
    if (!valor) {
      pintarBoletos(datosBoletos);
      return;
    }

    const filtrados = datosBoletos.filter(b => {
      const numeros = Array.isArray(b.numeros) ? b.numeros.map(n => String(n)) : [];
      return numeros.some(num => num.includes(valor));
    });

    pintarBoletos(filtrados);
  }

  function mostrarBNR() {
    const clave = prompt("Introduce la clave para ver el BNR:");
    if (clave === "admin2024") {
      const bnrContainer = document.getElementById('bnr-container');
      bnrContainer.classList.add('visible');
      calcularBNR();
    } else {
      alert("Clave incorrecta.");
    }
  }

  function calcularBNR() {
    const contador = {};
    datosBoletos.forEach(b => {
      (b.numeros || []).forEach(num => {
        const n = String(num);
        contador[n] = (contador[n] || 0) + 1;
      });
    });

    const repetidos = Object.entries(contador).filter(([num, count]) => count > 1).map(([num]) => num);

    const resultado = repetidos.length > 0 ? repetidos.join(', ') : "No hay nÃºmeros repetidos.";
    document.getElementById('bnr-result').textContent = resultado;
  }

  cargarBoletos();
</script>
</body>
</html>