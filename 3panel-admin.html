<!-- Librerías necesarias -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadString } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
import html2canvas from "https://cdn.skypack.dev/html2canvas";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyC-9BVF6sfbA1IcmawTtxFiwHOyHv0Qa3g",
  authDomain: "rifas-con-causa.firebaseapp.com",
  projectId: "rifas-con-causa",
  storageBucket: "rifas-con-causa.appspot.com",
  messagingSenderId: "347417635634",
  appId: "1:347417635634:web:3ddab8921d26707910452b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Roles
const accesos = {
  "Admin2024": "Administrador",
  "Miriam25": "Verificador",
  "VerifPatty26": "Verificador",
  "VerifDiane27": "Verificador",
  "VerifSteven28": "Verificador"
};

let usuarioRol = null;
let datosBoletos = [];

document.addEventListener("DOMContentLoaded", () => {
  const clave = prompt("🔒 Introduce tu contraseña:");
  if (accesos[clave]) {
    usuarioRol = accesos[clave];
    alert(`Bienvenido: ${usuarioRol}`);
    cargarBoletos();
  } else {
    alert("Acceso denegado.");
    window.location.href = "index.html";
  }
});

// Cargar boletos
async function cargarBoletos() {
  const querySnapshot = await getDocs(collection(db, "BoletosRifa"));
  datosBoletos = [];
  document.querySelector("#tablaBoletos tbody").innerHTML = "";
  querySnapshot.forEach(docSnap => datosBoletos.push(docSnap.data()));
  mostrarBoletos(datosBoletos);
}

// Mostrar en tabla
function mostrarBoletos(lista) {
  const tbody = document.querySelector("#tablaBoletos tbody");
  tbody.innerHTML = "";
  lista.forEach(boleto => {
    const idDoc = boleto.boleto.padStart(3, '0');
    let opcionesEstado = "";

    if (usuarioRol === "Administrador") {
      opcionesEstado = `<option disabled selected>Editar</option>
      <option value="libre">Disponible</option>
      <option value="apartado">Apartado</option>
      <option value="pagado">Pagado</option>`;
    } else if (usuarioRol === "Verificador" && boleto.estado === "apartado") {
      opcionesEstado = `<option disabled selected>Editar</option>
      <option value="pagado">Pagado</option>`;
    }

    const selectHtml = opcionesEstado ? `<select onchange="cambiarEstado('${idDoc}', this.value)">${opcionesEstado}</select>` : "🔒";

    tbody.innerHTML += `<tr>
      <td>#${idDoc}</td>
      <td>${boleto.nombre || ""}</td>
      <td>${boleto.telefono || ""}</td>
      <td>${boleto.poblacion || ""}</td>
      <td class="${boleto.estado}">${boleto.estado}</td>
      <td>${boleto.fecha ? new Date(boleto.fecha).toLocaleString() : ""}</td>
      <td>${selectHtml}</td>
      <td>${boleto.modificadoPor || ""}</td>
      <td>${boleto.formaPago || ""}</td>
    </tr>`;
  });
}

// Cambiar Estado con PNG y WhatsApp
window.cambiarEstado = async function(id, nuevoEstado) {
  const formaPago = nuevoEstado === "pagado" ? prompt("¿Forma de pago? (Efectivo, OXXO, etc.)") : "";

  const ref = doc(db, "BoletosRifa", id);
  await updateDoc(ref, { estado: nuevoEstado, modificadoPor: usuarioRol, formaPago: formaPago });
  mostrarNotificacion("✅ Guardado correctamente");

  if (nuevoEstado === "pagado") {
    const boletoDatos = datosBoletos.find(b => b.boleto === id);
    if (boletoDatos) {
      console.log("🎟️ Generando PNG para", boletoDatos.boleto);
      await generarYSubirBoleto(boletoDatos);

      console.log("📲 Abriendo WhatsApp para", boletoDatos.telefono);
      enviarBoletoWhatsapp(boletoDatos.boleto);
    } else {
      console.error("❌ No se encontró el boleto para generar PNG");
    }
  }

  cargarBoletos();
}

// Generar PNG y subir a Storage
async function generarYSubirBoleto(boleto) {
  document.getElementById("boleto-numero").textContent = `Boleto #${boleto.boleto.padStart(3, '0')}`;
  document.getElementById("boleto-nombre").textContent = `Nombre: ${boleto.nombre}`;
  document.getElementById("boleto-series").textContent = `Series: ${boleto.series.join(' - ')}`;
  document.getElementById("boleto-plantilla").style.display = 'block';

  const canvas = await html2canvas(document.getElementById("boleto-plantilla"));
  const imgData = canvas.toDataURL("image/png");

  const storageRef = ref(storage, `boletos/${boleto.boleto.padStart(3, '0')}.png`);
  await uploadString(storageRef, imgData.split(',')[1], 'base64');

  console.log("✅ Boleto PNG subido correctamente");
  document.getElementById("boleto-plantilla").style.display = 'none';
}

// Enviar por WhatsApp
function enviarBoletoWhatsapp(idBoleto) {
  const boleto = datosBoletos.find(b => b.boleto === idBoleto);
  if (!boleto || !boleto.telefono) {
    alert("No se encontró el teléfono del cliente.");
    return;
  }

  const numero = boleto.telefono.replace(/\D/g, '');
  const imagenURL = `https://firebasestorage.googleapis.com/v0/b/rifas-con-causa.appspot.com/o/boletos%2F${idBoleto}.png?alt=media`;
  const mensaje = encodeURIComponent(`¡Gracias por tu donativo! 🎉\nAquí está tu boleto digital:\n${imagenURL}`);
  const enlaceWhatsApp = `https://wa.me/52${numero}?text=${mensaje}`;

  window.open(enlaceWhatsApp, '_blank');
}

// Notificación visual
function mostrarNotificacion(mensaje) {
  const noti = document.getElementById("notificacion");
  noti.textContent = mensaje;
  noti.style.display = "block";
  setTimeout(() => noti.style.display = "none", 2000);
}
</script>

<!-- Plantilla del boleto (oculta) -->
<div id="boleto-plantilla" style="width:300px; padding:20px; border:2px solid green; display:none;">
  <h3 id="boleto-numero">Boleto #000</h3>
  <p id="boleto-nombre">Nombre: --</p>
  <p id="boleto-series">Series: --</p>
</div>
